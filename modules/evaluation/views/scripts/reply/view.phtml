<?php if ( $this->rs ) : ?>
    <?php
        $i = 1;
        $letters = array( 1 => 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z' );
        $noteTotal = 0;
    ?>
	<?php foreach( $this->rs as $key => $rs ):?>
        <?php $select = $rs->getTable()->select()->where( "version =?" , $this->version )?>
        <?php if( $rs->type == "text" ): ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <label for="<?=$i;?>" class="inline"><b><?=$rs->label;?></b></label> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <?php
                    $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select )->current();
                    $alternative = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" )->current();
                ?>
                <?php if( $alternative->value == $reply->value ):?>
                    <div style="color: green">
                        <?=$reply->value?>
                    </div>
                    <?php $note = $rs->note?>
                <?php else:?>
                    <div style="color: red">
                        <?=$reply->value?>
                    </div>
                    <?php $note = 0?>
                <?php endif; ?>
                
                <br />
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=$alternative->value?>
                    <?php if( isset( $alternative->justify ) && $alternative->justify ):?>
                        <br />
                        <b><?=$this->translate( "justify" )?>:</b> <?=$alternative->justify?>
                    <?php endif;?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format($note , "2")?></p>
                <?php $noteTotal += $note?>
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "truefalse" ): ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <b><?=$rs->label;?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <?php
                    $alternatives = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" );
                    $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select )->toArray();
                    $questions = 0;
                    $correct = 0;
                    $feedback = "";
                ?>
                <?php foreach( $alternatives as $key => $alternative ):?>
                    <?php $questions++?>
                    <?php if( $alternative->status == $reply["$key"]["value"] ):?>
                        <div style="color: green">
                            <?=$letters["$questions"]?>) <?=$reply["$key"]["value"]." - ".$alternative->value?>
                            <?php $correct++?>
                        </div>
                    <?php else:?>
                        <div style="color: red">
                            <?=$letters["$questions"]?>) <?=$reply["$key"]["value"]." - ".$alternative->value?>
                        </div>
                    <?php endif; ?>

                    <?php $feedback .= "{$letters["$questions"]}) - $alternative->status, "?>
                    <br />
                <?php endforeach;?>
                <br />
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=substr($feedback, 0 , -2)?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( ($correct*( $rs->note/$questions )) , "2")?></p>
                <?php $noteTotal += $correct*( $rs->note/$questions )?>
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "association" ): ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <b><?=$rs->label;?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <?php
                    $alternatives = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" );
                    $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select )->toArray();
                    $questions = 0;
                    $correct = 0;
                    $feedback = "";
                ?>
                <?php foreach( $alternatives as $key => $alternative ):?>
                    <?php $questions++?>
                    <?php if( $alternative->status == $reply["$key"]["value"] ):?>
                        <div style="color: green">
                            <?=$letters["$questions"]?>) <?=$reply["$key"]["value"]." - ".$alternative->value?>
                            <?php $correct++?>
                        </div>
                    <?php else:?>
                        <div style="color: red">
                            <?=$letters["$questions"]?>) <?=$reply["$key"]["value"]." - ".$alternative->value?>
                        </div>
                    <?php endif; ?>

                    <?php $feedback .= "{$letters["$questions"]}) - $alternative->status, "?>
                    <br />
                <?php endforeach;?>
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=substr($feedback, 0 , -2)?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( ($correct*( $rs->note/$questions )) , "2")?></p>
                <?php $noteTotal += $correct*( $rs->note/$questions )?>
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "radio" ): ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <b><?=$rs->label;?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <?php
                    $alternatives = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" );
                    $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select )->current();
                    $feedback = "";
                    $questions = 0;
                ?>
                <?php foreach( $alternatives as $key => $alternative ):?>
                    <?php $questions++;?>
                    <?php if( isset( $reply->evaluation_value_id ) && $alternative->id == $reply->evaluation_value_id ):?>
                        <div style="color: green">
                            <?=$letters["$questions"]?>) <?=$alternative->value?>
                            <?php $note = $rs->note?>
                        </div>
                    <?php else:?>
                        <div style="color: red">
                            <?=$letters["$questions"]?>) <?=$alternative->value?>
                            <?php $note = 0?>
                        </div>
                    <?php endif; ?>
                    <br />
                    <?php
                        if( $alternative->status == "V" ){
                            $feedback = $letters["$questions"].") ";
                        }
                    ?>

                <?php endforeach;?>
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=$feedback?>
                    <?php if( isset( $alternative->justify ) && $alternative->justify ):?>
                        <br />
                        <b><?=$this->translate( "justify" )?>:</b> <?=$alternative->justify?>
                    <?php endif;?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( $note , "2")?></p>
                <?php $noteTotal += $note ?>
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "checkbox" ): ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <b><?=$rs->label;?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <br />
                <?php
                    $alternatives = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" );
                    $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select )->toArray();
                    $questions = 0;
                    $correct = 0;
                    $feedback= "";
                ?>
                <?php foreach( $alternatives as $key => $alternative ):?>
                    <?php $questions++?>
                    <?php
                        if( isset( $reply["$key"] ) && ( $alternative->status == $reply["$key"]["value"] ) ){
                            echo '<div style="color: green">
                                    '.$letters["$questions"].') '.$alternative->value.'
                                  </div>';

                            if( $alternative->justify ){
                                echo '<p style="margin-top: 0px; margin-bottom: 0px;">'.$this->translate("justify").': '.$alternative->justify.'</p>';
                            }
                            $correct++;
                        }else if( @$alternative->status == null && @$reply["$key"]["value"] == null ){
                            echo '<div style="color: green">
                                    '.$letters["$questions"].') '.$alternative->value.'
                                  </div>';

                            if( $alternative->justify ){
                                echo '<p style="margin-top: 0px; margin-bottom: 0px;">'.$this->translate("justify").': '.$alternative->justify.'</p>';
                            }
                            $correct++;
                        }else{
                            echo '<div style="color: red">
                                    '.$letters["$questions"].') '.$alternative->value.'
                                  </div>';

                            if( $alternative->justify ){
                                echo '<p style="margin-top: 0px; margin-bottom: 0px;">'.$this->translate("justify").': '.$alternative->justify.'</p>';
                            }
                        }

                        if( $alternative->status == "V" ){
                            $feedback .= "{$letters["$questions"]}), ";
                        }
                    ?>
                    <br />
                <?php endforeach;?>
                <br />
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=substr($feedback, 0 , -2)?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( ($correct*( $rs->note/$questions )) , "2")?></p>
                <?php $noteTotal += $correct*( $rs->note/$questions ) ?>
                <br />
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "textarea" ): ?>
            <?php
                $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select  )->current();
                $note = 0;
            ?>
            <div class="question">
                <p><b><?=$i?>) <?=$rs->label?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <div>
                    <p><?=$reply->value?></p>
                </div>
                <?php
                    $note = $reply->findDependentRowset( "Evaluation_Model_EvaluationReplyNote" )->current()->note;
                    $noteTotal += $note;
                ?>
                <br />
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( $note , "2")?></p>
            </div>
            <br />
        <?php endif; ?>

        <?php if( $rs->type == "keyword" ): ?>
            <?php
                $reply = $rs->findDependentRowset( "Evaluation_Model_EvaluationReply" , null , $select  )->current();
                $alternative = $rs->findDependentRowset( "Evaluation_Model_EvaluationValue" )->current();
                $feedback= "";
                $correct = 0;
            ?>
            <div class="question">
                <p><b><?=$i;?>)</b> <b><?=$rs->label;?></b> - <?=$this->translate( "note" )?> (<?=number_format( $rs->note , 2);?>)</p>
                <br />
                <div>
                    <?php
                    $strs = explode( ',' , trim($alternative->status) );
					$ereg = "";
                    
					foreach ( $strs as $str )
					{
                        $ereg = eregi( "(".trim($str).")" , $reply->value );
						if ( $ereg ){
							$correct++;
                        }
					}
                    
                    ?>
                    <?=$this->translate("answer")?>: <?=$reply->value?>
                    <br /><br />
                </div>
                <div class="padding" style="background: #FFF; border: green solid 1px;">
                    <b><?=$this->translate( "feedback" )?>:</b> <?=$alternative->value?>
                </div>
                <p><b><?=$this->translate( "question note" )?>:</b> <?=number_format( (count( $correct )*( $rs->note/count( $strs ) )) , "2")?></p>
                <?php $noteTotal += count( $correct )*( $rs->note/count( $strs ) ) ?>
                <br />
            </div>
            <br />
        <?php endif; ?>
        <?php $i++; ?>
    <?php endforeach;?>
    
    <div>
        <h3><?=$this->translate( "total" )?>: <?=number_format( $noteTotal , "2")?></h3>
    </div>

    <script type="text/javascript">
        new Preceptor.util.AjaxUpdate( "note" , "<?=$this->url?>/evaluation/reply/save-note/note/<?=number_format( $noteTotal , "2")?>" );

        $( ".question" ).css({"background":"#EFEFEF" , "border":"#BBB 1px solid" , "padding":"5px"});
    </script>
    
<?php else : ?>
	<div class="message-table-sorter">
		<?=$this->translate('This assessment contains questions that are subject to correction by mentor') ?><br />
		<?=$this->translate('Watch for a correction to access your feedback') ?>
	</div>
<?php endif; ?>
<div id="note"></div>
